name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-macos:
    name: Package (macOS)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake simde qt@5

      - name: Clone OBS source (headers only)
        run: |
          git clone --depth 1 --branch 30.2.3 \
            https://github.com/obsproject/obs-studio.git /tmp/obs-studio

      - name: Locate OBS.app frameworks
        id: obs-paths
        run: |
          OBS_APP="/Applications/OBS.app"
          if [ ! -d "$OBS_APP" ]; then
            curl -L -o /tmp/obs.dmg \
              "https://cdn-fastly.obsproject.com/downloads/OBS-Studio-30.2.3-macOS-Apple.dmg"
            hdiutil attach /tmp/obs.dmg -nobrowse -mountpoint /tmp/obs-mount
            cp -R /tmp/obs-mount/OBS.app /tmp/OBS.app
            hdiutil detach /tmp/obs-mount
            OBS_APP="/tmp/OBS.app"
          fi
          echo "obs_app=${OBS_APP}" >> "$GITHUB_OUTPUT"
          echo "frameworks_dir=${OBS_APP}/Contents/Frameworks" >> "$GITHUB_OUTPUT"

      - name: Configure
        run: |
          cmake --preset default \
            -DOBS_INCLUDE_DIR=/tmp/obs-studio/libobs \
            -DOBS_LIBRARY="${{ steps.obs-paths.outputs.frameworks_dir }}/libobs.framework/libobs" \
            -DOBS_SOURCE_DIR=/tmp/obs-studio \
            -DOBS_FRAMEWORKS_DIR="${{ steps.obs-paths.outputs.frameworks_dir }}" \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@5)"

      - name: Build
        run: cmake --build build

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Create plugin bundle
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PAYLOAD="/tmp/pkg-payload/streamn-obs-scoreboard.plugin/Contents"
          mkdir -p "${PAYLOAD}/MacOS"
          cp build/streamn-obs-scoreboard.so "${PAYLOAD}/MacOS/streamn-obs-scoreboard"
          chmod +x "${PAYLOAD}/MacOS/streamn-obs-scoreboard"
          cat > "${PAYLOAD}/Info.plist" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>streamn-obs-scoreboard</string>
            <key>CFBundleIdentifier</key>
            <string>com.streamndad.streamn-obs-scoreboard</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>streamn-obs-scoreboard</string>
            <key>CFBundlePackageType</key>
            <string>BNDL</string>
            <key>CFBundleShortVersionString</key>
            <string>${VERSION}</string>
            <key>CFBundleVersion</key>
            <string>${VERSION}</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
          </dict>
          </plist>
          PLIST

      - name: Code sign (optional)
        if: env.MACOS_SIGNING_CERT != ''
        env:
          MACOS_SIGNING_CERT: ${{ secrets.MACOS_SIGNING_CERT }}
          MACOS_SIGNING_CERT_PASSWORD: ${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          echo "$MACOS_SIGNING_CERT" | base64 --decode > /tmp/cert.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import /tmp/cert.p12 -k build.keychain \
            -P "$MACOS_SIGNING_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "" build.keychain
          codesign --force --sign "$MACOS_SIGNING_IDENTITY" \
            --options runtime \
            "/tmp/pkg-payload/streamn-obs-scoreboard.plugin/Contents/MacOS/streamn-obs-scoreboard"

      - name: Package .pkg
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SCRIPTS="/tmp/pkg-scripts"
          mkdir -p "$SCRIPTS"
          cat > "${SCRIPTS}/postinstall" <<'SCRIPT'
          #!/bin/bash
          DEST="${HOME}/Library/Application Support/obs-studio/plugins"
          mkdir -p "$DEST"
          rm -rf "${DEST}/streamn-obs-scoreboard"
          rm -rf "${DEST}/streamn-obs-scoreboard.plugin"
          cp -R "/tmp/streamn-obs-scoreboard.plugin" "$DEST/"
          rm -rf "/tmp/streamn-obs-scoreboard.plugin"
          SCRIPT
          chmod +x "${SCRIPTS}/postinstall"
          pkgbuild \
            --root /tmp/pkg-payload \
            --scripts "$SCRIPTS" \
            --identifier com.streamndad.streamn-obs-scoreboard \
            --version "$VERSION" \
            --install-location /tmp \
            "streamn-obs-scoreboard-${VERSION}-macos.pkg"

      - name: Notarize (optional)
        if: env.MACOS_NOTARIZE_APPLE_ID != ''
        env:
          MACOS_NOTARIZE_APPLE_ID: ${{ secrets.MACOS_NOTARIZE_APPLE_ID }}
          MACOS_NOTARIZE_PASSWORD: ${{ secrets.MACOS_NOTARIZE_PASSWORD }}
          MACOS_NOTARIZE_TEAM_ID: ${{ secrets.MACOS_NOTARIZE_TEAM_ID }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          xcrun notarytool submit \
            "streamn-obs-scoreboard-${VERSION}-macos.pkg" \
            --apple-id "$MACOS_NOTARIZE_APPLE_ID" \
            --password "$MACOS_NOTARIZE_PASSWORD" \
            --team-id "$MACOS_NOTARIZE_TEAM_ID" \
            --wait
          xcrun stapler staple \
            "streamn-obs-scoreboard-${VERSION}-macos.pkg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: streamn-obs-scoreboard-*-macos.pkg

  build-linux:
    name: Package (Linux)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build qtbase5-dev libsimde-dev \
            qt6-base-dev qt6-base-private-dev libqt6svg6-dev \
            libjansson-dev libcurl4-openssl-dev libx264-dev \
            libwayland-dev libxkbcommon-dev libpipewire-0.3-dev \
            libpulse-dev libx11-xcb-dev libxcb-randr0-dev \
            libxcb-shm0-dev libxcb-xfixes0-dev libxcb-composite0-dev \
            libxcb-xinerama0-dev libxcomposite-dev libgl1-mesa-dev \
            swig python3-dev libavcodec-dev libavdevice-dev \
            libavfilter-dev libavformat-dev libavutil-dev libswscale-dev \
            libswresample-dev libspeexdsp-dev libmbedtls-dev \
            librist-dev libsrt-openssl-dev nlohmann-json3-dev \
            libwebsocketpp-dev libasio-dev libqrcodegencpp-dev \
            uthash-dev

      - name: Clone OBS source
        run: |
          git clone --depth 1 --branch 30.2.3 \
            https://github.com/obsproject/obs-studio.git /tmp/obs-studio

      - name: Build minimal OBS (libobs + frontend API)
        run: |
          cmake -S /tmp/obs-studio -B /tmp/obs-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_PLUGINS=OFF \
            -DENABLE_UI=ON \
            -DENABLE_SCRIPTING=OFF \
            -DENABLE_AJA=OFF \
            -DENABLE_BROWSER=OFF \
            -DENABLE_WEBSOCKET=OFF \
            -DENABLE_VST=OFF \
            -DENABLE_NEW_MPEGTS_OUTPUT=OFF
          cmake --build /tmp/obs-build --target obs-frontend-api
          cmake --build /tmp/obs-build --target obs

      - name: Find OBS libraries
        id: obs-libs
        run: |
          OBS_LIB=$(find /tmp/obs-build -name "libobs.so*" -not -type l | head -1)
          FRONTEND_LIB=$(find /tmp/obs-build -name "libobs-frontend-api.so*" -not -type l | head -1)
          echo "obs_library=${OBS_LIB}" >> "$GITHUB_OUTPUT"
          echo "frontend_library=${FRONTEND_LIB}" >> "$GITHUB_OUTPUT"

      - name: Configure
        run: |
          cmake --preset linux \
            -DOBS_INCLUDE_DIR=/tmp/obs-studio/libobs \
            -DOBS_LIBRARY="${{ steps.obs-libs.outputs.obs_library }}" \
            -DOBS_SOURCE_DIR=/tmp/obs-studio \
            -DOBS_FRONTEND_API_LIBRARY="${{ steps.obs-libs.outputs.frontend_library }}"

      - name: Build
        run: cmake --build build

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Package .tar.gz
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          STAGING="/tmp/tar-root/obs-plugins"
          mkdir -p "$STAGING"
          cp build/streamn-obs-scoreboard.so "$STAGING/"
          tar -czf "streamn-obs-scoreboard-${VERSION}-linux-x86_64.tar.gz" \
            -C /tmp/tar-root obs-plugins

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: streamn-obs-scoreboard-*-linux-x86_64.tar.gz

  build-windows:
    name: Package (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt5
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          arch: 'win64_msvc2019_64'

      - name: Clone OBS source (headers only)
        run: |
          git clone --depth 1 --branch 30.2.3 `
            https://github.com/obsproject/obs-studio.git obs-source

      - name: Download OBS release and generate import libraries
        shell: pwsh
        run: |
          curl -L -o obs.zip `
            "https://github.com/obsproject/obs-studio/releases/download/30.2.3/OBS-Studio-30.2.3-Windows.zip"
          Expand-Archive obs.zip -DestinationPath obs-release

          $obsDll = Get-ChildItem -Recurse -Filter "obs.dll" -Path obs-release | Select-Object -First 1
          $frontendDll = Get-ChildItem -Recurse -Filter "obs-frontend-api.dll" -Path obs-release | Select-Object -First 1

          if (-not $obsDll) { Write-Error "obs.dll not found"; exit 1 }
          if (-not $frontendDll) { Write-Error "obs-frontend-api.dll not found"; exit 1 }

          New-Item -ItemType Directory -Force -Path obs-libs | Out-Null

          $exports = & dumpbin /exports $obsDll.FullName
          $defLines = @("LIBRARY `"obs.dll`"", "EXPORTS")
          foreach ($line in $exports) {
            if ($line -match "^\s+\d+\s+[0-9A-Fa-f]+\s+[0-9A-Fa-f]+\s+(\S+)") {
              $defLines += "    $($Matches[1])"
            }
          }
          $defLines | Out-File -Encoding ASCII "obs-libs/obs.def"
          & lib /def:obs-libs/obs.def /out:obs-libs/obs.lib /machine:x64

          $exports = & dumpbin /exports $frontendDll.FullName
          $defLines = @("LIBRARY `"obs-frontend-api.dll`"", "EXPORTS")
          foreach ($line in $exports) {
            if ($line -match "^\s+\d+\s+[0-9A-Fa-f]+\s+[0-9A-Fa-f]+\s+(\S+)") {
              $defLines += "    $($Matches[1])"
            }
          }
          $defLines | Out-File -Encoding ASCII "obs-libs/obs-frontend-api.def"
          & lib /def:obs-libs/obs-frontend-api.def /out:obs-libs/obs-frontend-api.lib /machine:x64

          Get-ChildItem obs-libs/*.lib

      - name: Configure
        run: |
          cmake --preset windows `
            -DOBS_INCLUDE_DIR="obs-source/libobs" `
            -DOBS_LIBRARY="obs-libs/obs.lib" `
            -DOBS_SOURCE_DIR="obs-source" `
            -DOBS_FRONTEND_API_LIBRARY="obs-libs/obs-frontend-api.lib"

      - name: Build
        run: cmake --build build --config RelWithDebInfo

      - name: Test
        run: ctest --test-dir build -C RelWithDebInfo --output-on-failure

      - name: Code sign (optional)
        if: env.WINDOWS_SIGNING_CERT != ''
        env:
          WINDOWS_SIGNING_CERT: ${{ secrets.WINDOWS_SIGNING_CERT }}
          WINDOWS_SIGNING_CERT_PASSWORD: ${{ secrets.WINDOWS_SIGNING_CERT_PASSWORD }}
        shell: pwsh
        run: |
          [IO.File]::WriteAllBytes("cert.pfx",
            [Convert]::FromBase64String($env:WINDOWS_SIGNING_CERT))
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" `
            sign /f cert.pfx /p $env:WINDOWS_SIGNING_CERT_PASSWORD /fd sha256 /tr http://timestamp.digicert.com /td sha256 `
            build/RelWithDebInfo/streamn-obs-scoreboard.dll
          Remove-Item cert.pfx

      - name: Package .zip
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          $staging = "pkg-root/obs-plugins/64bit"
          New-Item -ItemType Directory -Force -Path $staging
          Copy-Item "build/RelWithDebInfo/streamn-obs-scoreboard.dll" $staging
          Compress-Archive -Path "pkg-root/obs-plugins" `
            -DestinationPath "streamn-obs-scoreboard-${version}-windows-x64.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: streamn-obs-scoreboard-*-windows-x64.zip

  create-release:
    name: Create Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-24.04
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: artifacts/*
