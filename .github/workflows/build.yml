name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            preset: linux
          - os: macos-14
            preset: default
          - os: windows-latest
            preset: windows
    steps:
      - uses: actions/checkout@v4

      - name: Install Ninja (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y ninja-build

      - name: Configure (core-only)
        run: cmake --preset ${{ matrix.preset }} -DBUILD_PLUGIN_MODULE=OFF

      - name: Build
        run: cmake --build build ${{ runner.os == 'Windows' && '--config RelWithDebInfo' || '' }}

      - name: Test
        run: ctest --test-dir build ${{ runner.os == 'Windows' && '-C RelWithDebInfo' || '' }} --output-on-failure

  build-macos:
    name: Build (macOS)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake simde qt@5

      - name: Clone OBS source (headers only)
        run: |
          git clone --depth 1 --branch 30.2.3 \
            https://github.com/obsproject/obs-studio.git /tmp/obs-studio

      - name: Locate OBS.app frameworks
        id: obs-paths
        run: |
          OBS_APP="/Applications/OBS.app"
          if [ ! -d "$OBS_APP" ]; then
            echo "OBS.app not found â€” downloading release DMG"
            curl -L -o /tmp/obs.dmg \
              "https://cdn-fastly.obsproject.com/downloads/OBS-Studio-30.2.3-macOS-Apple.dmg"
            hdiutil attach /tmp/obs.dmg -nobrowse -mountpoint /tmp/obs-mount
            cp -R /tmp/obs-mount/OBS.app /tmp/OBS.app
            hdiutil detach /tmp/obs-mount
            OBS_APP="/tmp/OBS.app"
          fi
          echo "obs_app=${OBS_APP}" >> "$GITHUB_OUTPUT"
          echo "frameworks_dir=${OBS_APP}/Contents/Frameworks" >> "$GITHUB_OUTPUT"

      - name: Configure
        run: |
          cmake --preset default \
            -DOBS_INCLUDE_DIR=/tmp/obs-studio/libobs \
            -DOBS_LIBRARY="${{ steps.obs-paths.outputs.frameworks_dir }}/libobs.framework/libobs" \
            -DOBS_SOURCE_DIR=/tmp/obs-studio \
            -DOBS_FRAMEWORKS_DIR="${{ steps.obs-paths.outputs.frameworks_dir }}" \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@5)"

      - name: Build
        run: cmake --build build

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-macos
          path: build/streamn-obs-scoreboard.so

  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build qtbase5-dev libsimde-dev \
            libjansson-dev libcurl4-openssl-dev libx264-dev \
            libwayland-dev libxkbcommon-dev libpipewire-0.3-dev \
            libpulse-dev libx11-xcb-dev libxcb-randr0-dev \
            libxcb-shm0-dev libxcb-xfixes0-dev libxcb-composite0-dev \
            libxcb-xinerama0-dev libxcomposite-dev libgl1-mesa-dev \
            swig python3-dev libavcodec-dev libavdevice-dev \
            libavfilter-dev libavformat-dev libavutil-dev libswscale-dev \
            libswresample-dev libspeexdsp-dev libmbedtls-dev \
            librist-dev libsrt-openssl-dev nlohmann-json3-dev \
            libwebsocketpp-dev libasio-dev libqrcodegencpp-dev \
            uthash-dev

      - name: Clone OBS source
        run: |
          git clone --depth 1 --branch 30.2.3 \
            https://github.com/obsproject/obs-studio.git /tmp/obs-studio

      - name: Build minimal OBS (libobs + frontend API)
        run: |
          cmake -S /tmp/obs-studio -B /tmp/obs-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_PLUGINS=OFF \
            -DENABLE_UI=ON \
            -DENABLE_SCRIPTING=OFF \
            -DENABLE_AJA=OFF \
            -DENABLE_BROWSER=OFF \
            -DENABLE_WEBSOCKET=OFF \
            -DENABLE_VST=OFF \
            -DENABLE_NEW_MPEGTS_OUTPUT=OFF
          cmake --build /tmp/obs-build --target obs-frontend-api
          cmake --build /tmp/obs-build --target obs

      - name: Find OBS libraries
        id: obs-libs
        run: |
          OBS_LIB=$(find /tmp/obs-build -name "libobs.so*" -not -type l | head -1)
          FRONTEND_LIB=$(find /tmp/obs-build -name "libobs-frontend-api.so*" -not -type l | head -1)
          echo "obs_library=${OBS_LIB}" >> "$GITHUB_OUTPUT"
          echo "frontend_library=${FRONTEND_LIB}" >> "$GITHUB_OUTPUT"

      - name: Configure
        run: |
          cmake --preset linux \
            -DOBS_INCLUDE_DIR=/tmp/obs-studio/libobs \
            -DOBS_LIBRARY="${{ steps.obs-libs.outputs.obs_library }}" \
            -DOBS_SOURCE_DIR=/tmp/obs-studio \
            -DOBS_FRONTEND_API_LIBRARY="${{ steps.obs-libs.outputs.frontend_library }}"

      - name: Build
        run: cmake --build build

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-linux
          path: build/streamn-obs-scoreboard.so

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt5
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          arch: 'win64_msvc2019_64'

      - name: Clone OBS source (headers only)
        run: |
          git clone --depth 1 --branch 30.2.3 `
            https://github.com/obsproject/obs-studio.git obs-source

      - name: Download OBS release and generate import libraries
        shell: pwsh
        run: |
          curl -L -o obs.zip `
            "https://github.com/obsproject/obs-studio/releases/download/30.2.3/OBS-Studio-30.2.3-Windows.zip"
          Expand-Archive obs.zip -DestinationPath obs-release

          $obsDll = Get-ChildItem -Recurse -Filter "obs.dll" -Path obs-release | Select-Object -First 1
          $frontendDll = Get-ChildItem -Recurse -Filter "obs-frontend-api.dll" -Path obs-release | Select-Object -First 1

          if (-not $obsDll) { Write-Error "obs.dll not found"; exit 1 }
          if (-not $frontendDll) { Write-Error "obs-frontend-api.dll not found"; exit 1 }

          New-Item -ItemType Directory -Force -Path obs-libs | Out-Null

          # Generate obs.lib from obs.dll
          $exports = & dumpbin /exports $obsDll.FullName
          $defLines = @("LIBRARY `"obs.dll`"", "EXPORTS")
          foreach ($line in $exports) {
            if ($line -match "^\s+\d+\s+[0-9A-Fa-f]+\s+[0-9A-Fa-f]+\s+(\S+)") {
              $defLines += "    $($Matches[1])"
            }
          }
          $defLines | Out-File -Encoding ASCII "obs-libs/obs.def"
          & lib /def:obs-libs/obs.def /out:obs-libs/obs.lib /machine:x64

          # Generate obs-frontend-api.lib from obs-frontend-api.dll
          $exports = & dumpbin /exports $frontendDll.FullName
          $defLines = @("LIBRARY `"obs-frontend-api.dll`"", "EXPORTS")
          foreach ($line in $exports) {
            if ($line -match "^\s+\d+\s+[0-9A-Fa-f]+\s+[0-9A-Fa-f]+\s+(\S+)") {
              $defLines += "    $($Matches[1])"
            }
          }
          $defLines | Out-File -Encoding ASCII "obs-libs/obs-frontend-api.def"
          & lib /def:obs-libs/obs-frontend-api.def /out:obs-libs/obs-frontend-api.lib /machine:x64

          Get-ChildItem obs-libs/*.lib

      - name: Configure
        run: |
          cmake --preset windows `
            -DOBS_INCLUDE_DIR="obs-source/libobs" `
            -DOBS_LIBRARY="obs-libs/obs.lib" `
            -DOBS_SOURCE_DIR="obs-source" `
            -DOBS_FRONTEND_API_LIBRARY="obs-libs/obs-frontend-api.lib"

      - name: Build
        run: cmake --build build --config RelWithDebInfo

      - name: Test
        run: ctest --test-dir build -C RelWithDebInfo --output-on-failure

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-windows
          path: build/RelWithDebInfo/streamn-obs-scoreboard.dll

  coverage:
    name: Coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build gcovr

      - name: Configure
        run: cmake --preset coverage

      - name: Build
        run: cmake --build build-coverage

      - name: Test
        run: ctest --test-dir build-coverage --output-on-failure

      - name: Enforce 100% line coverage
        run: ./scripts/coverage.sh build-coverage
